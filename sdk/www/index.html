<html>
<head>
  <title>Signing State Machines</title>
</head>

<script src="crypto-js/crypto-js.js"></script>
<script src="jsencrypt/jsencrypt.js"></script>
<script src="vis/vis.js"></script>

<script src="bcc-xmlhttp.js"></script>
<script src="ssm-api.js"></script>
<script src="ssm-view.js"></script>
<script type="text/javascript">

var viewElements = {
	"access": ['access_host__Fld', 'access_port__Fld', 'access_id__Fld', 'access_prv__Fld'],
	"user": ['user_id__Fld', 'user_pub__Fld', 'user_prv__Fld', 'user_list__Tbl'],
	"session": ['session_id__Fld', 'session_action__Fld', 'session_data__Fld', 'session_list__Tbl', 'session_log__Tbl'],
	"ssm": ['ssm_id__Fld', 'ssm_data__Fld', 'ssm_list__Tbl', 'ssm_graph__Cnv']
}

function argsFromQueryString(queryString) {
	var args = {};
	if (!queryString)
		return args;
	var getVars = decodeURI(queryString).split("\&");
	for (var i=0; i<getVars.length; i++) {
		var varVal = getVars[i].split("\=");
		if (varVal.length == 2)
			args[varVal[0]] = varVal[1];
	}
	return args;
}

function logError(result) {
	console.log(result)
	document.getElementById('data__Fld').innerHTML = "<b>Error:</b> " + result;
}

function logResult(result) {
	console.log(result)
	document.getElementById('data__Fld').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function clearView(elements) {
	elements.map(function(id) {
		document.getElementById(id).innerHTML = "";
		document.getElementById(id).value = "";
	});
}

function logSSM(result) {
	var ssm = JSON.parse(result);
	var cnv = document.getElementById('ssm_graph__Cnv');
	ssmView(ssm, cnv);
	document.getElementById('ssm_data__Fld').innerHTML = JSON.stringify(ssm,null,2);
}

function listSSM(result) {
	document.getElementById('ssm_list__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function logSession(result) {
	document.getElementById('session_data__Fld').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function listSession(result) {
	document.getElementById('session_list__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function listSessionLog(result) {
	document.getElementById('session_log__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function logUser(result) {
	var usr = JSON.parse(result);
	document.getElementById('user_id__Fld').value = usr.name;
	document.getElementById('user_pub__Fld').value = usr.pub;
}

function listUser(result) {
	document.getElementById('user_list__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function usrGenerateKeyPair() {
	JSE.key = null;
	document.getElementById('user_prv__Fld').value = JSE.getPrivateKey();
	document.getElementById('user_pub__Fld').value = JSE.getPublicKey();
}

function ssmQuerySetup(keyType, onOk, onError) {
	var keyId = document.getElementById((keyType == 'admin' ? 'user' : keyType) + '_id__Fld').value;
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var hostCmd = ssmQuery(keyType, keyId);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, onOk ? onOk : logResult , onError ? onError : logError);
	return cbctx;
}

function ssmListSetup(keyType, onOk, onError) {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var hostCmd = ssmQuery("list", keyType);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, onOk ? onOk : logResult , onError ? onError : logError);
	return cbctx;
}

function ssmLogSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var fcn = "log";
	var queryId = document.getElementById('session_id__Fld').value;
	var hostCmd = ssmQuery(fcn, queryId);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, listSessionLog, logError);
	return cbctx;
}

function ssmRegisterSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var user = {
		name: document.getElementById('user_id__Fld').value,
		pub: flattenPublicKey(document.getElementById('user_pub__Fld').value)
	}
	var admin = document.getElementById('access_id__Fld').value;
	var adminKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmRegister(user, admin, adminKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function ssmCreateSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var ssm = JSON.parse(document.getElementById('ssm_data__Fld').value);
	var admin = document.getElementById('access_id__Fld').value;
	var adminKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmCreate(ssm, admin, adminKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function ssmStartSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var session = JSON.parse(document.getElementById('session_data__Fld').value);
	var admin = document.getElementById('access_id__Fld').value;
	var adminKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmStart(session, admin, adminKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function ssmPerformSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var context = JSON.parse(document.getElementById('session_data__Fld').value);
	var action = document.getElementById('session_action__Fld').value;
	var user = document.getElementById('access_id__Fld').value;
	var userKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmPerform(action, context, user, userKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function initView() {
	var args = argsFromQueryString(window.location.toString().split("\?")[1]);
	if (args.host)
		document.getElementById('access_host__Fld').value = args.host;
	if (args.port)
		document.getElementById('access_port__Fld').value = args.port;
}

</script>



<body onload="initView()">

<h1>Signing State Machines</h1>



<hr>
<h2>Access</h2>
<div id="access__View">

<br>
Server
<input type="text" value="127.0.0.1" id="access_host__Fld">:<input type="text" value="8080" id="access_port__Fld">

<br>
User
<input type="text" id="access_id__Fld">

<br>
Private key
<textarea rows="28" cols="64" id="access_prv__Fld">
</textarea>

<br>
<input type="button" value="clear view" onclick="clearView(viewElements['access'])"/>
</div>



<hr>
<h2>User</h2>
<div id="user__View">

<br>
User
<input type="text" id="user_id__Fld">
<input type="button" value="query user" onclick="ssmQuerySetup('user',logUser)"/>
<input type="button" value="query admin" onclick="ssmQuerySetup('admin',logUser)"/>

<br>
Public key
<input type="button" value="register user" onclick="ssmRegisterSetup()"/>
<textarea rows="8" cols="64" id="user_pub__Fld">
</textarea>

<br>
Private key
<input type="button" value="generate key pair" onclick="usrGenerateKeyPair()"/>
<textarea rows="28" cols="64" id="user_prv__Fld">
</textarea>

<br>
<input type="button" value="list users" onclick="ssmListSetup('user',listUser)"/>
<input type="button" value="list admins" onclick="ssmListSetup('admin',listUser)"/>
<textarea rows="8" cols="12" id="user_list__Tbl">
</textarea>

<br>
<input type="button" value="clear view" onclick="clearView(viewElements['user'])"/>
</div>



<hr>
<h2>Session</h2>
<div id="session__View">

<br>
Session
<input type="text" id="session_id__Fld">
<input type="button" value="query session" onclick="ssmQuerySetup('session',logSession)"/>

<br>
Action
<input type="text" id="session_action__Fld">
<input type="button" value="perform action" onclick="ssmPerformSetup()"/>

<br>
State
<input type="button" value="start session" onclick="ssmStartSetup()"/>
<textarea rows="12" cols="64" id="session_data__Fld">
</textarea>

<br>
<input type="button" value="list sessions" onclick="ssmListSetup('session',listSession)"/>
<textarea rows="8" cols="12" id="session_list__Tbl">
</textarea>

<br>
<input type="button" value="log session" onclick="ssmLogSetup()"/>
<textarea rows="8" cols="12" id="session_log__Tbl">
</textarea>

<br>
<input type="button" value="clear view" onclick="clearView(viewElements['session'])"/>
</div>



<hr>
<h2>State Machine</h2>
<div id="ssm__View">

<br>
SSM
<input type="text" id="ssm_id__Fld">
<input type="button" value="query SSM" onclick="ssmQuerySetup('ssm',logSSM)"/>

<br>
State Machine
<input type="button" value="create SSM" onclick="ssmCreateSetup()"/>
<textarea rows="12" cols="64" id="ssm_data__Fld">
</textarea>

<br>
<input type="button" value="list SSM" onclick="ssmListSetup('ssm',listSSM)"/>
<textarea rows="8" cols="12" id="ssm_list__Tbl">
</textarea>

<br>
<div style="min-width:320px;min-height:200px;border-style:solid;border-width:1px" id="ssm_graph__Cnv">
</div>

<br>
<input type="button" value="clear view" onclick="clearView(viewElements['ssm'])"/>
</div>

<hr>

<pre style="width:100%;min-height:320px" id="data__Fld">
</pre>
</div>

</body>
</html>
