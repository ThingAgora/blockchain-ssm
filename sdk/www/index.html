<html>

<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signing State Machines</title>
</head>


<link rel="stylesheet" type="text/css" href="mdl/material.min.css">
<script src="mdl/material.min.js"></script>

<script src="crypto-js/crypto-js.js"></script>
<script src="jsencrypt/jsencrypt.js"></script>
<script src="vis/vis.js"></script>

<script src="bcc-xmlhttp.js"></script>
<script src="ssm-api.js"></script>
<script src="ssm-view.js"></script>
<script type="text/javascript">

var viewElements = {
	"access": ['access_host__Fld', 'access_port__Fld', 'access_id__Fld', 'access_prv__Fld', 'data__Fld'],
	"user": ['user_id__Fld', 'user_pub__Fld', 'user_prv__Fld', 'user_list__Tbl', 'data__Fld'],
	"session": ['session_id__Fld', 'session_action__Fld', 'session_data__Fld', 'session_list__Tbl', 'session_log__Tbl', 'data__Fld'],
	"ssm": ['ssm_id__Fld', 'ssm_data__Fld', 'ssm_list__Tbl', 'ssm_graph__Cnv', 'data__Fld']
}

function argsFromQueryString(queryString) {
	var args = {};
	if (!queryString)
		return args;
	var getVars = decodeURI(queryString).split("\&");
	for (var i=0; i<getVars.length; i++) {
		var varVal = getVars[i].split("\=");
		if (varVal.length == 2)
			args[varVal[0]] = varVal[1];
	}
	return args;
}

function logError(result) {
	console.log(result)
	document.getElementById('data__Fld').innerHTML = "<b>Error:</b> " + result;
}

function logResult(result) {
	console.log(result)
	document.getElementById('data__Fld').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function clearView(elements) {
	elements.map(function(id) {
		document.getElementById(id).innerHTML = "";
		document.getElementById(id).value = "";
	});
}

function logSSM(result) {
	var ssm = JSON.parse(result);
	var cnv = document.getElementById('ssm_graph__Cnv');
	ssmView(ssm, cnv);
	document.getElementById('ssm_data__Fld').innerHTML = JSON.stringify(ssm,null,2);
}

function listSSM(result) {
	document.getElementById('ssm_list__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function logSession(result) {
	document.getElementById('session_data__Fld').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function listSession(result) {
	document.getElementById('session_list__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function listSessionLog(result) {
	document.getElementById('session_log__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function logUser(result) {
	var usr = JSON.parse(result);
	document.getElementById('user_id__Fld').value = usr.name;
	document.getElementById('user_pub__Fld').value = usr.pub;
}

function listUser(result) {
	document.getElementById('user_list__Tbl').innerHTML = JSON.stringify(JSON.parse(result),null,2);
}

function usrGenerateKeyPair() {
	JSE.key = null;
	document.getElementById('user_prv__Fld').value = JSE.getPrivateKey();
	document.getElementById('user_pub__Fld').value = JSE.getPublicKey();
}

function ssmQuerySetup(keyType, onOk, onError) {
	var keyId = document.getElementById((keyType == 'admin' ? 'user' : keyType) + '_id__Fld').value;
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var hostCmd = ssmQuery(keyType, keyId);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, onOk ? onOk : logResult , onError ? onError : logError);
	return cbctx;
}

function ssmListSetup(keyType, onOk, onError) {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var hostCmd = ssmQuery("list", keyType);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, onOk ? onOk : logResult , onError ? onError : logError);
	return cbctx;
}

function ssmLogSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var fcn = "log";
	var queryId = document.getElementById('session_id__Fld').value;
	var hostCmd = ssmQuery(fcn, queryId);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, listSessionLog, logError);
	return cbctx;
}

function ssmRegisterSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var user = {
		name: document.getElementById('user_id__Fld').value,
		pub: flattenPublicKey(document.getElementById('user_pub__Fld').value)
	}
	var admin = document.getElementById('access_id__Fld').value;
	var adminKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmRegister(user, admin, adminKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function ssmCreateSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var ssm = JSON.parse(document.getElementById('ssm_data__Fld').value);
	var admin = document.getElementById('access_id__Fld').value;
	var adminKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmCreate(ssm, admin, adminKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function ssmStartSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var session = JSON.parse(document.getElementById('session_data__Fld').value);
	var admin = document.getElementById('access_id__Fld').value;
	var adminKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmStart(session, admin, adminKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function ssmPerformSetup() {
	var uri = "http://" + document.getElementById('access_host__Fld').value + ":" + document.getElementById('access_port__Fld').value;
	var context = JSON.parse(document.getElementById('session_data__Fld').value);
	var action = document.getElementById('session_action__Fld').value;
	var user = document.getElementById('access_id__Fld').value;
	var userKey = document.getElementById('access_prv__Fld').value;
	var hostCmd = ssmPerform(action, context, user, userKey);
	var cbctx = bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logError);
	return cbctx;
}

function initView() {
	var args = argsFromQueryString(window.location.toString().split("\?")[1]);
	if (args.host)
		document.getElementById('access_host__Fld').value = args.host;
	if (args.port)
		document.getElementById('access_port__Fld').value = args.port;
}

</script>



<body onload="initView()">

<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">

<header class="mdl-layout__header">
  <div class="mdl-layout__header-row">
    <span class="mdl-layout-title"><a href="https://github.com/civis-blockchain/blockchain-ssm">Signing State Machines</a></span>
  </div>
  <div class="mdl-layout__tab-bar mdl-js-ripple-effect">
    <a href="#data__View" class="mdl-layout__tab">&nbsp;</a>
    <a href="#access__View" class="mdl-layout__tab">Access</a>
    <a href="#user__View" class="mdl-layout__tab">User</a>
    <a href="#session__View" class="mdl-layout__tab">Session</a>
    <a href="#ssm__View" class="mdl-layout__tab">State Machine</a>
  </div>
</header>

<main class="mdl-layout__content">


<section class="mdl-layout__tab-panel" id="data__View">
<div class="page-content">
<pre id='data__Fld'></pre>
</div>
</section>


<section class="mdl-layout__tab-panel" id="access__View">
<div class="page-content">

<div class="mdl-grid">

<div class="mdl-cell mdl-cell--3-col">
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="access_host__TxtFld">
      <input class="mdl-textfield__input" type="text" value="127.0.0.1" id="access_host__Fld">
      <label class="mdl-textfield__label" for="access_host__TxtFld">Host addess</label>
  </div>
</div>
<div class="mdl-cell mdl-cell--1-col">
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="access_port__TxtFld">
      <input class="mdl-textfield__input" type="text" value="8080" id="access_port__Fld">
      <label class="mdl-textfield__label" for="access_port__TxtFld">Port</label>
  </div>
</div>

<div class="mdl-cell mdl-cell--8-col mdl-cell--hide-phone mdl-layout-spacer">
</div>

<div class="mdl-cell mdl-cell--4-col">
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="access_id__TxtFld">
      <input class="mdl-textfield__input" type="text" id="access_id__Fld">
      <label class="mdl-textfield__label" for="access_id__TxtFld">User</label>
  </div>
</div>

<div class="mdl-cell mdl-cell--8-col mdl-cell--hide-phone mdl-layout-spacer">
</div>

<div class="mdl-cell mdl-cell--4-col">
Private key
</div>

<div class="mdl-cell mdl-cell--8-col mdl-cell--hide-phone mdl-layout-spacer">
</div>

<div class="mdl-cell mdl-cell--8-col mdl-cell--4-col-phone">
<div style="width:95%" class="mdl-textfield mdl-js-textfield mdl-color--primary mdl-color-text--primary-contrast" id="access_prv__TxtFld">
<textarea rows="28" cols="64" class="mdl-textfield__input" style="font-family:monospace" id="access_prv__Fld"></textarea>
</div>
</div>

<div class="mdl-cell mdl-cell--4-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="clearView(viewElements['access'])">
Clear view
</button>
</div>

</div>
</div>
</section>



<section class="mdl-layout__tab-panel" id="user__View">
<div class="page-content">

<div class="mdl-grid">

<div class="mdl-cell mdl-cell--4-col">
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="user_id__TxtFld">
      <input class="mdl-textfield__input" type="text" id="user_id__Fld">
      <label class="mdl-textfield__label" for="user_id__TxtFld">User</label>
  </div>
</div>

<div class="mdl-cell mdl-cell--2-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="ssmQuerySetup('user',logUser)">
query user
</button>
</div>

<div class="mdl-cell mdl-cell--2-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="ssmQuerySetup('admin',logUser)">
query admin
</button>
</div>

<div class="mdl-cell mdl-cell--2-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="ssmListSetup('user',listUser)">
list users
</button>
</div>

<div class="mdl-cell mdl-cell--2-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="ssmListSetup('admin',listUser)">
list admins
</button>
</div>

<div class="mdl-cell mdl-cell--6-col mdl-cell--2-col-phone">
Public key
</div>

<div class="mdl-cell mdl-cell--2-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="ssmRegisterSetup()">
register user
</button>
</div>

<div class="mdl-cell mdl-cell--4-col mdl-cell--hide-phone mdl-layout-spacer">
</div>

<div class="mdl-cell mdl-cell--8-col mdl-cell--4-col-phone">
<div style="width:95%" class="mdl-textfield mdl-js-textfield mdl-color--primary mdl-color-text--primary-contrast" id="user_pub__TxtFld">
<textarea rows="8" cols="64" class="mdl-textfield__input" style="font-family:monospace" id="user_pub__Fld"></textarea>
</div>
</div>

<div class="mdl-cell mdl-cell--4-col mdl-cell--hide-phone mdl-layout-spacer">
</div>

<div class="mdl-cell mdl-cell--6-col mdl-cell--2-col-phone">
Private key
</div>

<div class="mdl-cell mdl-cell--2-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="usrGenerateKeyPair()">
generate key pair
</button>
</div>

<div class="mdl-cell mdl-cell--4-col mdl-cell--hide-phone mdl-layout-spacer">
</div>

<div class="mdl-cell mdl-cell--8-col mdl-cell--4-col-phone">
<div style="width:95%" class="mdl-textfield mdl-js-textfield mdl-color--primary mdl-color-text--primary-contrast" id="user_prv__TxtFld">
<textarea rows="28" cols="64" class="mdl-textfield__input" style="font-family:monospace" id="user_prv__Fld"></textarea>
</div>
</div>

<div class="mdl-cell mdl-cell--4-col">
<button type="button" class="mdl-button mdl-js-button mdl-button--raised" onclick="clearView(viewElements['user'])">
Clear view
</button>
</div>




<div class="mdl-cell mdl-cell--12-col mdl-cell--4-col-phone">
<div style="width:95%" class="mdl-textfield mdl-js-textfield mdl-color--primary mdl-color-text--primary-contrast" id="user_list__TxtTbl">
<textarea class="mdl-textfield__input" style="font-family:monospace"  rows="8" cols="12" id="user_list__Tbl"></textarea>
</div>
</div>

</div>
</section>



<section class="mdl-layout__tab-panel" id="session__View">
<div class="page-content">

<br>
Session
<input type="text" id="session_id__Fld">
<input type="button" value="query session" onclick="ssmQuerySetup('session',logSession)"/>

<br>
Action
<input type="text" id="session_action__Fld">
<input type="button" value="perform action" onclick="ssmPerformSetup()"/>

<br>
State
<input type="button" value="start session" onclick="ssmStartSetup()"/>
<textarea rows="12" cols="64" id="session_data__Fld">
</textarea>

<br>
<input type="button" value="list sessions" onclick="ssmListSetup('session',listSession)"/>
<textarea rows="8" cols="12" id="session_list__Tbl">
</textarea>

<br>
<input type="button" value="log session" onclick="ssmLogSetup()"/>
<textarea rows="8" cols="12" id="session_log__Tbl">
</textarea>

<br>
<input type="button" value="clear view" onclick="clearView(viewElements['session'])"/>
</div>
</section>



<section class="mdl-layout__tab-panel" id="ssm__View">
<div class="page-content">

<br>
SSM
<input type="text" id="ssm_id__Fld">
<input type="button" value="query SSM" onclick="ssmQuerySetup('ssm',logSSM)"/>

<br>
State Machine
<input type="button" value="create SSM" onclick="ssmCreateSetup()"/>
<textarea rows="12" cols="64" id="ssm_data__Fld">
</textarea>

<br>
<input type="button" value="list SSM" onclick="ssmListSetup('ssm',listSSM)"/>
<textarea rows="8" cols="12" id="ssm_list__Tbl">
</textarea>

<br>
<div style="min-width:320px;min-height:200px;border-style:solid;border-width:1px" id="ssm_graph__Cnv">
</div>

<br>
<input type="button" value="clear view" onclick="clearView(viewElements['ssm'])"/>
</div>
</section>


</main>

</div>



</body>
</html>
